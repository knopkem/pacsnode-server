var g;(g=g||{}).Constants=g.Constants||{},g.Constants.toolColor="lime",g.Constants.handleSize=20,(g=g||{}).MathHelper=g.MathHelper||{},g.MathHelper.lineDistance=function(t,e){"use strict";var i=0,s=0;return i=e.x-t.x,i*=i,s=e.y-t.y,s*=s,Math.sqrt(i+s)},g.MathHelper.world2Image=function(t,e,i){"use strict";if(void 0!==t&&void 0!==e&&void 0!==i){var s=new g.Point2D;return s.x=(t.x-e.x)/i,s.y=(t.y-e.y)/i,s}log.error("invalid input, cannot compute I2W")},g.MathHelper.image2World=function(t,e,i){"use strict";if(void 0!==t&&void 0!==e&&void 0!==i){var s=new g.Point2D;return s.x=e.x+t.x*i,s.y=e.y+t.y*i,s}log.error("invalid input, cannot compute I2W")},g.MathHelper.world2Offset=function(t,e,i,s){"use strict";var n=new g.Point2D,o=g.MathHelper.world2Image(t,e,i);return n.x=(s*o.x-t.x)/-1,n.y=(s*o.y-t.y)/-1,n},g.MathHelper.clamp=function(t,e,i){"use strict";return Math.min(Math.max(t,e),i)},g.MathHelper.dotProduct=function(t,e){"use strict";return t.x*e.x+t.y*e.y},g.MathHelper.crossProduct=function(t,e){"use strict";return t.x*e.y-t.y*e.x},g.MathHelper.magnitude=function(t,e){"use strict";return Math.sqrt(g.MathHelper.dotProduct(t,e))},g.MathHelper.angleBetweenPoints=function(t,e,i){"use strict";var s=new g.Point2D,n=new g.Point2D;return s.x=t.x-i.x,s.y=t.y-i.y,n.x=e.x-i.x,n.y=e.y-i.y,Math.abs(g.MathHelper.angle(s,n))},g.MathHelper.angle=function(t,e){"use strict";var i=g.MathHelper.crossProduct(t,e),s=g.MathHelper.dotProduct(t,e);return 180*Math.atan2(i,s)/Math.PI},g.MathHelper.roundTo=function(t,e){"use strict";var i=Math.pow(10,e);return Math.round(t*i)/i},g.MathHelper.computeRoi=function(t,e){"use strict";var i,s,n,o,r=0,a=0,h=0,l=0,c=99999,u=0,d={},p=0,g=0,w=[];for(a=0;a<e.header.rows();a+=1)for(h=0;h<e.header.cols();h+=1)t.isHit(h,a)&&(p+=u=e.imageData[r]*e.header.slope()+e.header.intercept(),w[g]=u,g+=1,l=Math.max(l,u),c=Math.min(c,u)),r+=1;return d.min=c,d.max=l,d.mean=p/g,d.stdDev=(s=w,n=d.mean,o=s.map(function(t){var e=t-n;return e*e}),Math.sqrt((i=o).reduce(function(t,e){return t+e},0)/i.length)),d.area=g,d},window.pubsub=function(){"use strict";var i,s={};return{sub:function(t,e){s.hasOwnProperty(t)||(s[t]=[]),s[t].push(e)},pub:function(t,e){if(s.hasOwnProperty(t))for(i=0;i<s[t].length;i+=1)try{s[t][i].call(null,e)}catch(t){log.error(t)}}}}(),(g=g||{}).LookupTable=function(){"use strict";this.huLookup=[],this.ylookup=[],this.rescaleSlope=1,this.rescaleIntercept=0,this.windowCenter=0,this.windowWidth=0,this.lastSlope=-1,this.lastIntercept=-1,this.lastCenter=-1,this.lastWidth=-1,this.lastMin=0,this.lastMax=0},g.LookupTable.prototype.setData=function(t,e,i,s){"use strict";this.windowCenter=parseInt(t,10),this.windowWidth=parseInt(e,10),this.rescaleSlope=i,this.rescaleIntercept=s},g.LookupTable.prototype.calculateHULookup=function(t,e){"use strict";if(this.lastSlope!==this.rescaleSlope||this.lastIntercept!==this.rescaleIntercept||this.lastMin!==t||this.lastMax!==e){var i=0,s=0;for(i=t;i<=e;i+=1)s=parseFloat(i*this.rescaleSlope+this.rescaleIntercept,10),this.huLookup[i]=s;this.lastSlope=this.rescaleSlope,this.lastIntercept=this.rescaleIntercept}},g.LookupTable.prototype.calculateLookup=function(t,e){"use strict";if(this.lastCenter!==this.windowCenter||this.lastWidth!==this.windowWidth||this.lastMin!==t||this.lastMax!==e){var i=this.windowCenter-.5-(this.windowWidth-1)/2,s=this.windowCenter-.5+(this.windowWidth-1)/2,n=0,o=0;for(n=t;n<=e;n+=1)this.huLookup[n]<=i?this.ylookup[n]=0:this.huLookup[n]>s?this.ylookup[n]=255:(o=255*((this.huLookup[n]-(this.windowCenter-.5))/(this.windowWidth-1)+.5)+0,this.ylookup[n]=parseInt(o,10));this.lastCenter=this.windowCenter,this.lastWidth=this.windowWidth,this.lastMin=t,this.lastMax=e}},(g=g||{}).DicomHeader=function(t){"use strict";this.dicomData=t,this.minPx=0,this.maxPx=0},g.DicomHeader.prototype.slope=function(){"use strict";var t=parseFloat(this.dicomData.DCM_RescaleSlope);return(isNaN(t)||0===t||"undefined"===t)&&(t=1),t},g.DicomHeader.prototype.intercept=function(){"use strict";var t=parseInt(this.dicomData.DCM_RescaleIntercept,10);return isNaN(t)&&(t=0),t},g.DicomHeader.prototype.windowWidth=function(){"use strict";var t=parseInt(this.dicomData.DCM_WindowWidth,10);return isNaN(t)&&(t=4096),t},g.DicomHeader.prototype.windowCenter=function(){"use strict";var t=parseInt(this.dicomData.DCM_WindowCenter,10);return isNaN(t)&&(t=2048),t},g.DicomHeader.prototype.cols=function(){"use strict";var t=parseInt(this.dicomData.DCM_Columns,10);return isNaN(t)&&(t=512),t},g.DicomHeader.prototype.rows=function(){"use strict";var t=parseInt(this.dicomData.DCM_Rows,10);return isNaN(t)&&(t=512),t},g.DicomHeader.prototype.invert=function(){"use strict";return"MONOCHROME1"===this.dicomData.DCM_PhotoMetricInterpretation},g.DicomHeader.prototype.setMinPixelValue=function(t){"use strict";this.minPx=t},g.DicomHeader.prototype.minPixelValue=function(){"use strict";return this.minPx},g.DicomHeader.prototype.setMaxPixelValue=function(t){"use strict";this.maxPx=t},g.DicomHeader.prototype.maxPixelValue=function(){"use strict";return this.maxPx},g.DicomHeader.prototype.pixelSpacing=function(){"use strict";var t=new g.Point2D,e=this.dicomData.DCM_PixelSpacing.split("/");return 1===e.length?(t.x=parseFloat(e[0]),t.y=t.x):2===e.length?(t.x=parseFloat(e[0]),t.y=parseFloat(e[1])):(log.war("Failed parsing pixelspacing, assuming 1.0",e),t.x=1,t.y=1),t},(g=g||{}).DicomObject=function(t,e,i,s,n){"use strict";this.header=t,this.imageData=e,this.header.setMinPixelValue(i),this.header.setMaxPixelValue(s),this.q=n},g.DicomObject.prototype.getHeader=function(){"use strict";return this.header},g.DicomObject.prototype.getImageData=function(){"use strict";return this.imageData},g.DicomObject.prototype.getQuality=function(){"use strict";return this.q},(g=g||{}).DicomLoader=function(){"use strict";this.lastTimeout=0,this.lastDeferred=null},g.DicomLoader.prototype.load=function(t,e,i){"use strict";var s=Q.defer(),n=this;return 0!==this.lastTimeout&&null!==this.lastDeferred&&(window.clearTimeout(this.lastTimeout),this.lastTimeout=0,this.lastDeferred.reject()),this.lastTimeout=window.setTimeout(function(){n.loadHeader(t,i).then(function(t){s.resolve(t)})},e),(this.lastDeferred=s).promise},g.DicomLoader.prototype.loadHeader=function(e,i){"use strict";log.debug("load header");var t="/full"+e+"&type=header",s=new XMLHttpRequest,n=this,o=Q.defer();return s.open("GET",t,!0),s.onreadystatechange=function(){var t=null;if(4===s.readyState){if(204===s.status)return log.debug("received progressing message"),window.setTimeout(function(){n.loadHeader(e,i).then(function(t){o.resolve(t)})},500),o.promise;200===s.status&&(log.debug("load header done"),t=new g.DicomHeader(JSON.parse(s.responseText)),n.loadDicomData(t,e,i).then(function(t){o.resolve(t)}))}},s.send(null),o.promise},g.DicomLoader.prototype.loadDicomData=function(i,t,s){"use strict";log.debug("load dicom data");var n=this,o=null,r=Q.defer();return Q.all([n.loadImage(i,t,s,"a"),n.loadImage(i,t,s,"b")]).spread(function(t,e){log.debug("load dicom data done"),o=n.createBuffer(i,t,e,s),r.resolve(o)}),r.promise},g.DicomLoader.prototype.loadImage=function(n,t,e,i){"use strict";var o=new Image,s="/full"+t+"&type="+i+"&quality="+e,r=Q.defer(),a=null;return log.debug("retrieving data",i),o.onload=function(){var t=document.createElement("canvas"),e=t.getContext("2d"),i=n.cols(),s=n.rows();t.width=i,t.height=s,e.drawImage(o,0,0,i,s),a=e.getImageData(0,0,i,s),r.resolve(a)},o.src=s,r.promise},g.DicomLoader.prototype.createBuffer=function(t,e,i,s){"use strict";if(null!==e)if(null!==i){if(null!==t){log.debug("createBuffer");var n=0,o=0,r=e.data,a=i.data,h=99999999,l=0,c=0,u=new ArrayBuffer(e.data.length),d=new Int16Array(u);for(c=0;c<r.length;c+=4)n=256*r[c]+a[c],d[o]=n,l=Math.max(l,n),h=Math.min(h,n),o+=1;return new g.DicomObject(t,d,h,l,s)}log.error("header not parsed")}else log.error("invalid data buffer b");else log.error("invalid data buffer a")},(g=g||{}).DicomProcessor=function(){"use strict";this.lookup=new g.LookupTable},g.DicomProcessor.prototype.getRenderData=function(t,e,i){"use strict";log.debug("processBuffer");var s=t.getHeader(),n=t.getImageData(),o=document.createElement("canvas"),r=o.getContext("2d"),a=0,h=0,l=0,c=0,u=0,d=this.lookup.ylookup,p=0,g=s.rows(),w=s.cols();for(this.lookup.setData(e,i,s.slope(),s.intercept()),this.lookup.calculateHULookup(s.minPixelValue(),s.maxPixelValue()),this.lookup.calculateLookup(s.minPixelValue(),s.maxPixelValue()),o.width=w,o.height=g,p=r.createImageData(o.width,o.height),h=0;h<g;h+=1)for(l=0;l<w;l+=1)c=4*(h*w+l),u=parseInt(d[n[a]],10),s.invert()&&(u=256-u),p.data[c]=u,p.data[c+1]=u,p.data[c+2]=u,p.data[c+3]=255,a+=1;return p},(g=g||{}).MemoryCache=function(){"use strict";this.hash=new Hashtable},g.MemoryCache.prototype.init=function(){"use strict";var t=Q.defer();return t.resolve(),t.promise},g.MemoryCache.prototype.add=function(t,e){"use strict";var i=Q.defer();return i.resolve(),log.debug("adding to memory cache",t),this.hash.put(t,e),i.promise},g.MemoryCache.prototype.get=function(t){"use strict";var e=Q.defer();return this.hash.containsKey(t)?e.resolve(this.hash.get(t)):e.reject(),e.promise},g.MemoryCache.prototype.remove=function(t){"use strict";var e=Q.defer();return e.resolve(),log.debug("removing from memory cache",t),this.hash.remove(t),e.promise},g.MemoryCache.prototype.contains=function(t){"use strict";var e=Q.defer();return this.hash.containsKey(t)?e.resolve():e.reject(),e.promise},g.MemoryCache.prototype.clear=function(){"use strict";var t=Q.defer();return t.resolve(),log.debug("clear all memory cache"),this.hash.clear(),t.promise},(g=g||{}).CacheManager=function(){"use strict";this.cObject=new g.MemoryCache,this.init(),this.clear()},g.CacheManager.prototype.init=function(){"use strict";return this.cObject.init()},g.CacheManager.prototype.add=function(t,e){"use strict";return this.cObject.add(t,e)},g.CacheManager.prototype.get=function(t){"use strict";return this.cObject.get(t)},g.CacheManager.prototype.remove=function(t){"use strict";return this.cObject.remove(t)},g.CacheManager.prototype.contains=function(t){"use strict";return this.cObject.contains(t)},g.CacheManager.prototype.clear=function(){"use strict";return this.cObject.clear()},(g=g||{}).Preloader=function(t,e){"use strict";this.callback=e,this.cacheMgr=t,this.worklist=[],this.allInstances=[],this.baseURL="",this.loader=new g.DicomLoader,this.running=!1,this.timeArr=[]},g.Preloader.prototype.median=function(t){"use strict";t.sort(function(t,e){return t-e});var e=Math.floor(t.length/2);return t.length%2?t[e]:(t[e-1]+t[e])/2},g.Preloader.prototype.mean=function(t){"use strict";var e=0,i=0;for(i=0;i<t.length;i++)e+=parseInt(t[i],10);return parseInt(e/t.length,10)},g.Preloader.prototype.init=function(t,e){"use strict";this.running=!1,this.timeArr=[],this.baseURL=t,this.allInstances=e,this.worklist=e.slice(0)},g.Preloader.prototype.sortWorklist=function(t){"use strict";if(void 0!==t){var e=this.allInstances.indexOf(t);if(e<0)log.error("sorting failed, instance not found in array",t);else{var i=this.allInstances.slice(0,e),s=this.allInstances.slice(e),n=[];if(i.length+s.length===this.allInstances.length){for(;0<i.length||0<s.length;){if(0<i.length){var o=i.pop();-1!==this.worklist.indexOf(o)&&n.push(o)}if(0<s.length){var r=s.shift();-1!==this.worklist.indexOf(r)&&n.push(r)}}this.worklist.length===n.length?this.worklist=n:log.error("creating sorted array failed, array sizes differ",this.worklist.length,n.length)}else log.error("initializing sorting failed, array sizes differ",i.length+s.length,this.allInstances.length)}}else log.error("invalid input")},g.Preloader.prototype.start=function(t){"use strict";this.running?log.warn("preloader already running"):(log.debug("starting preloader"),this.running=!0,this.sortWorklist(t),this.nextSlice())},g.Preloader.prototype.stop=function(){"use strict";log.debug("stopping preloader"),this.running=!1},g.Preloader.prototype.nextSlice=function(){"use strict";log.debug("next slice");var a=this,h=0;if(this.running){if(0===this.worklist.length)return log.debug("no more slices"),void(this.running=!1);var l=this.worklist.shift();if(void 0===l)return log.warn("slice is undefined"),void(this.running=!1);h=(new Date).getTime(),this.cacheMgr.contains(l).then(function(){t(null)},function(){log.debug("loading next slice",l),a.loader.load(a.baseURL+l,10,100).then(t,function(){log.error("failed loading data for",a.baseURL+l),a.nextSlice()})})}function t(t){var e,i=parseInt(a.allInstances.length,10),s=parseInt(a.worklist.length,10),n=(new Date).getTime();a.timeArr[a.timeArr.length]=n-h;var o=a.median(a.timeArr),r=parseInt(o*s/1e3,10);if(log.debug("time remaining",n-h,o,s,r),r,e=parseInt(100*(i-s)/i,10),a.callback(e,r),t)try{a.cacheMgr.add(l,t).then(function(){log.debug("data saved")},function(){log.error("failed to add data"),a.running=!1})}catch(t){log.error(t)}a.nextSlice()}},g.Preloader.prototype.isRunning=function(){"use strict";return this.running},(g=g||{}).Handle=function(t,e){"use strict";this.imagePt=new g.Point2D,this.imagePt.x=t,this.imagePt.y=e,this.radius=g.Constants.handleSize,this.modified=!0,this.hitOffset=new g.Point2D},g.Handle.prototype.isHit=function(t,e,i){"use strict";if(void 0===t||void 0===e||void 0===i)return log.error("invalid input"),!1;var s,n=t,o=g.MathHelper.image2World(this.imagePt,e,i),r=g.MathHelper.world2Image(t,e,i),a=n.x-o.x,h=n.y-o.y;return(s=a*a+h*h<=this.radius*this.radius)&&(this.hitOffset.x=this.imagePt.x-r.x,this.hitOffset.y=this.imagePt.y-r.y),s},g.Handle.prototype.translate=function(t,e,i){"use strict";var s=g.MathHelper.image2World(this.imagePt,e,i);s.x+=t.x,s.y+=t.y,this.updatePosition(s,e,i)},g.Handle.prototype.updatePosition=function(t,e,i){"use strict";void 0!==t&&void 0!==e&&void 0!==i?(this.imagePt=g.MathHelper.world2Image(t,e,i),this.imagePt.x+=this.hitOffset.x,this.imagePt.y+=this.hitOffset.y,this.modified=!0):log.error("invalid input, cannot update position")},g.Handle.prototype.draw=function(t,e,i){"use strict";if(void 0!==e&&void 0!==i){var s=g.MathHelper.image2World(this.imagePt,e,i);t.setLineDash||(t.setLineDash=function(){}),t.strokeStyle=g.Constants.toolColor,t.setLineDash([]),t.lineWidth=1,t.beginPath(),t.arc(s.x,s.y,this.radius/3,0,2*Math.PI,!1),t.stroke(),t.closePath(),t.strokeStyle="white",t.setLineDash([5,3]),t.lineWidth=1,t.beginPath(),t.arc(s.x,s.y,this.radius,0,2*Math.PI,!1),t.stroke(),t.closePath()}else log.error("invalid input, cannot draw handle")},g.Handle.prototype.isModified=function(){"use strict";return this.modified},g.Handle.prototype.resetModified=function(){"use strict";this.modified=!1,this.hitOffset.x=0,this.hitOffset.y=0},(g=g||{}).Label=function(){"use strict";this.context=null,this.pt1=null,this.text="",this.offset=null,this.zoom=null},g.Label.prototype.draw=function(t,e,i,s,n){"use strict";this.context=t,this.pt1=e,this.text=i,this.offset=s,this.zoom=n,this.render()},g.Label.prototype.render=function(){"use strict";var t=g.MathHelper.image2World(this.pt1,this.offset,this.zoom),e=this.text.split("\n"),i=0;for(t.x+=40,this.context.font="10pt Helvetica bold, sans-serif",this.context.fillStyle=g.Constants.toolColor,this.context.strokeStyle="black",this.context.textAlign="start",i=0;i<e.length;i+=1)this.context.fillText(e[i],t.x,t.y+15*i)},(g=g||{}).Line=function(){"use strict";this.imagePt1=new g.Point2D,this.imagePt2=new g.Point2D},g.Line.prototype.init=function(t,e){"use strict";this.imagePt1=t,this.imagePt2=e},g.Line.prototype.draw=function(t,e,i,s,n){"use strict";this.imagePt1=e,this.imagePt2=i;var o=g.MathHelper.image2World(e,s,n),r=g.MathHelper.image2World(i,s,n);t.setLineDash([]),t.strokeStyle=g.Constants.toolColor,t.lineWidth=1,t.beginPath(),t.moveTo(o.x,o.y),t.lineTo(r.x,r.y),t.stroke(),t.closePath()},g.Line.prototype.isHit=function(t,e,i){"use strict";if(void 0===t||void 0===e||void 0===i)return log.error("invalid input"),!1;var s,n,o,r,a,h,l,c,u=g.MathHelper.world2Image(t,e,i);function d(t){return t*t}function p(t,e){return d(t.x-e.x)+d(t.y-e.y)}return h=u,l=this.imagePt1,c=this.imagePt2,Math.sqrt((s=h,a=p(n=l,o=c),p(s,0===a?n:(r=((s.x-n.x)*(o.x-n.x)+(s.y-n.y)*(o.y-n.y))/a)<0?n:1<r?o:{x:n.x+r*(o.x-n.x),y:n.y+r*(o.y-n.y)})))<=g.Constants.handleSize/i},(g=g||{}).Circle=function(){},g.Circle.prototype.draw=function(t,e,i,s,n){"use strict";var o=g.MathHelper.image2World(e,s,n),r=g.MathHelper.image2World(i,s,n),a=g.MathHelper.lineDistance(o,r)/2,h=new g.Point2D;h.x=(r.x+o.x)/2,h.y=(r.y+o.y)/2,t.setLineDash([]),t.strokeStyle=g.Constants.toolColor,t.lineWidth=1,t.beginPath(),t.arc(h.x,h.y,a,0,2*Math.PI,!1),t.stroke(),t.closePath()},g.Circle.prototype.computeRoi=function(t,e,i){"use strict";var s={center:new g.Point2D,radius:g.MathHelper.lineDistance(e,i)/2,isHit:function(t,e){var i=t-this.center.x,s=e-this.center.y;return i*i+s*s<this.radius*this.radius},init:function(){this.center.x=(i.x+e.x)/2,this.center.y=(i.y+e.y)/2}};return s.init(),g.MathHelper.computeRoi(s,t)},g.Circle.circleHitTest=function(t,e,i){"use strict";var s=i.x-t.x,n=i.y-t.y;return s*s+n*n<e*e},(g=g||{}).Rectangle=function(){},g.Rectangle.prototype.draw=function(t,e,i,s,n){"use strict";var o=g.MathHelper.image2World(e,s,n),r=g.MathHelper.image2World(i,s,n),a=r.x-o.x,h=r.y-o.y;t.setLineDash([]),t.strokeStyle=g.Constants.toolColor,t.lineWidth=1,t.beginPath(),t.rect(o.x,o.y,a,h),t.stroke(),t.closePath()},g.Rectangle.prototype.createHitObj=function(t,e){"use strict";var i={Xmin:t.x,Ymin:t.y,Xmax:e.x,Ymax:e.y,isHit:function(t,e){return!(t>this.Xmax||t<this.Xmin||e>this.Ymax||e<this.Ymin)},init:function(){t.x>e.x&&(this.Xmin=e.x,this.Xmax=t.x),t.y>e.y&&(this.Ymin=e.y,this.Ymax=t.y)}};return i.init(),i},g.Rectangle.prototype.computeRoi=function(t,e,i){"use strict";var s=this.createHitObj(e,i);return g.MathHelper.computeRoi(s,t)},g.Rectangle.prototype.isBodyHit=function(t,e,i,s,n){"use strict";var o=new g.Point2D(s.imagePt.x,s.imagePt.y),r=new g.Point2D(n.imagePt.x,s.imagePt.y),a=new g.Point2D(n.imagePt.x,n.imagePt.y),h=new g.Point2D(s.imagePt.x,n.imagePt.y),l=new g.Line,c=new g.Line,u=new g.Line,d=new g.Line;return l.init(o,r),c.init(r,a),u.init(a,h),d.init(h,o),l.isHit(t,e,i)||c.isHit(t,e,i)||u.isHit(t,e,i)||d.isHit(t,e,i)},(g=g||{}).DistanceTool=function(t,e,i){"use strict";var s=g.MathHelper.world2Image(t,e,i);this.handle1=new g.Handle(s.x,s.y/2),this.handle2=new g.Handle(s.x-s.x/2,s.y+s.y/2),this.line=new g.Line,this.label=new g.Label,this.activeElement=null,this.bodyHitPt=null},g.DistanceTool.prototype.updatePosition=function(t,e,i){"use strict";if(this.activeElement)this.activeElement.updatePosition(t,e,i);else if(this.bodyHitPt){var s=new g.Point2D;s.x=t.x-this.bodyHitPt.x,s.y=t.y-this.bodyHitPt.y,this.handle1.translate(s,e,i),this.handle2.translate(s,e,i),this.bodyHitPt=t}},g.DistanceTool.prototype.draw=function(t,e,i,s){"use strict";if(void 0!==t)if(void 0!==t.getHeader()){var n,o=new g.Point2D(this.handle1.imagePt.x,this.handle1.imagePt.y),r=new g.Point2D(this.handle2.imagePt.x,this.handle2.imagePt.y),a=t.getHeader().pixelSpacing();o.x*=a.x,o.y*=a.y,r.x*=a.x,r.y*=a.y,n=g.MathHelper.lineDistance(o,r),this.handle1.draw(e,i,s),this.handle2.draw(e,i,s),this.line.draw(e,this.handle1.imagePt,this.handle2.imagePt,i,s),this.label.draw(e,this.handle2.imagePt,Math.round(n)+" mm",i,s)}else log.warn("no header set, cannot draw");else log.warn("no dicom object set, cannot draw")},g.DistanceTool.prototype.isHit=function(t,e,i){"use strict";return this.handle1.isHit(t,e,i)?(this.activeElement=this.handle1,!0):this.handle2.isHit(t,e,i)?(this.activeElement=this.handle2,!0):!!this.line.isHit(t,e,i)&&(this.bodyHitPt=t,!0)},g.DistanceTool.prototype.reset=function(){"use strict";this.activeElement=null,this.bodyHitPt=null,this.handle1.resetModified(),this.handle2.resetModified()},(g=g||{}).AngleTool=function(t,e,i){"use strict";var s=g.MathHelper.world2Image(t,e,i);this.handle1=new g.Handle(s.x/2,s.y/2),this.handle2=new g.Handle(s.x+s.x/2,s.y/2),this.centerHandle=new g.Handle(s.x,s.y+s.y/2),this.line1=new g.Line,this.line2=new g.Line,this.label=new g.Label,this.activeElement=null,this.bodyHitPt=null},g.AngleTool.prototype.updatePosition=function(t,e,i){"use strict";if(this.activeElement)this.activeElement.updatePosition(t,e,i);else if(this.bodyHitPt){var s=new g.Point2D;s.x=t.x-this.bodyHitPt.x,s.y=t.y-this.bodyHitPt.y,this.handle1.translate(s,e,i),this.handle2.translate(s,e,i),this.centerHandle.translate(s,e,i),this.bodyHitPt=t}},g.AngleTool.prototype.draw=function(t,e,i,s){"use strict";var n;this.handle1.draw(e,i,s),this.handle2.draw(e,i,s),this.centerHandle.draw(e,i,s),this.line1.draw(e,this.handle1.imagePt,this.centerHandle.imagePt,i,s),this.line2.draw(e,this.handle2.imagePt,this.centerHandle.imagePt,i,s),n=g.MathHelper.angleBetweenPoints(this.handle1.imagePt,this.handle2.imagePt,this.centerHandle.imagePt),this.label.draw(e,this.centerHandle.imagePt,Math.round(n)+" °",i,s)},g.AngleTool.prototype.isHit=function(t,e,i){"use strict";return this.handle1.isHit(t,e,i)?(this.activeElement=this.handle1,!0):this.handle2.isHit(t,e,i)?(this.activeElement=this.handle2,!0):this.centerHandle.isHit(t,e,i)?(this.activeElement=this.centerHandle,!0):!(!this.line1.isHit(t,e,i)&&!this.line2.isHit(t,e,i))&&(this.bodyHitPt=t,!0)},g.AngleTool.prototype.reset=function(){"use strict";this.activeElement=null,this.bodyHitPt=null,this.handle1.resetModified(),this.handle2.resetModified(),this.centerHandle.resetModified()},(g=g||{}).CobbAngleTool=function(t,e,i){"use strict";var s=g.MathHelper.world2Image(t,e,i);this.handle1=new g.Handle(s.x/2,s.y/2),this.handle2=new g.Handle(s.x+s.x/2,s.y/2),this.handle3=new g.Handle(s.x/2,s.y+s.y/2),this.handle4=new g.Handle(s.x+s.x/2,s.y+s.y/2),this.line1=new g.Line,this.line2=new g.Line,this.line3=new g.Line,this.label=new g.Label,this.activeElement=null,this.bodyHitPt=null},g.CobbAngleTool.prototype.updatePosition=function(t,e,i){"use strict";if(this.activeElement)this.activeElement.updatePosition(t,e,i);else if(this.bodyHitPt){var s=new g.Point2D;s.x=t.x-this.bodyHitPt.x,s.y=t.y-this.bodyHitPt.y,this.handle1.translate(s,e,i),this.handle2.translate(s,e,i),this.handle3.translate(s,e,i),this.handle4.translate(s,e,i),this.bodyHitPt=t}},g.CobbAngleTool.prototype.draw=function(t,e,i,s){"use strict";this.handle1.draw(e,i,s),this.handle2.draw(e,i,s),this.handle3.draw(e,i,s),this.handle4.draw(e,i,s),this.line1.draw(e,this.handle1.imagePt,this.handle2.imagePt,i,s),this.line2.draw(e,this.handle3.imagePt,this.handle4.imagePt,i,s);var n,o=new g.Point2D,r=new g.Point2D,a=new g.Point2D,h=new g.Point2D,l=new g.Point2D;o.x=(this.handle1.imagePt.x+this.handle2.imagePt.x)/2,o.y=(this.handle1.imagePt.y+this.handle2.imagePt.y)/2,r.x=(this.handle3.imagePt.x+this.handle4.imagePt.x)/2,r.y=(this.handle3.imagePt.y+this.handle4.imagePt.y)/2,a.x=(o.x+r.x)/2,a.y=(o.y+r.y)/2,h.x=-1*(this.handle1.imagePt.y-this.handle2.imagePt.y),h.y=this.handle1.imagePt.x-this.handle2.imagePt.x,l.x=-1*(this.handle3.imagePt.y-this.handle4.imagePt.y),l.y=this.handle3.imagePt.x-this.handle4.imagePt.x,n=g.MathHelper.angle(h,l),this.line3.draw(e,o,r,i,s),this.label.draw(e,a,"cobb angle: "+Math.round(n)+" °",i,s)},g.CobbAngleTool.prototype.isHit=function(t,e,i){"use strict";return this.handle1.isHit(t,e,i)?(this.activeElement=this.handle1,!0):this.handle2.isHit(t,e,i)?(this.activeElement=this.handle2,!0):this.handle3.isHit(t,e,i)?(this.activeElement=this.handle3,!0):this.handle4.isHit(t,e,i)?(this.activeElement=this.handle4,!0):!!(this.line1.isHit(t,e,i)||this.line2.isHit(t,e,i)||this.line3.isHit(t,e,i))&&(this.bodyHitPt=t,!0)},g.CobbAngleTool.prototype.reset=function(){"use strict";this.activeElement=null,this.bodyHitPt=null,this.handle1.resetModified(),this.handle2.resetModified(),this.handle3.resetModified(),this.handle4.resetModified()},(g=g||{}).PointProbeTool=function(t,e,i){"use strict";var s=g.MathHelper.world2Image(t,e,i);this.handle1=new g.Handle(s.x,s.y),this.label=new g.Label,this.activeElement=null},g.PointProbeTool.prototype.updatePosition=function(t,e,i){"use strict";this.activeElement&&this.activeElement.updatePosition(t,e,i)},g.PointProbeTool.prototype.draw=function(t,e,i,s){"use strict";var n="",o=0,r=0,a=0;this.handle1.draw(e,i,s),this.handle1.isModified()?(0<(o=(r=parseInt(this.handle1.imagePt.x,10))+(a=parseInt(this.handle1.imagePt.y,10))*t.getHeader().cols())&&o<t.imageData.length?(n=n="Value ("+r.toString()+", "+a.toString()+"): "+(t.imageData[o]*t.header.slope()+t.header.intercept()).toString(),this.label.draw(e,this.handle1.imagePt,n,i,s)):this.label.draw(e,this.handle1.imagePt,"out of range: "+o.toString()+" | "+t.imageData.length.toString(),i,s),this.handle1.resetModified()):this.label.draw(e,this.handle1.imagePt,this.label.text,i,s)},g.PointProbeTool.prototype.isHit=function(t,e,i){"use strict";return!!this.handle1.isHit(t,e,i)&&(this.activeElement=this.handle1,!0)},g.PointProbeTool.prototype.reset=function(){"use strict";this.activeElement=null},(g=g||{}).RectangularRoiTool=function(t,e,i){"use strict";var s=g.MathHelper.world2Image(t,e,i);this.handle1=new g.Handle(s.x/2,s.y/2),this.handle2=new g.Handle(s.x+s.x/2,s.y+s.y/2),this.rectangle=new g.Rectangle,this.activeElement=null,this.label=new g.Label,this.invisibleCanvas=window.document.createElement("canvas"),this.dicomObject=null,this.timeoutHandle=null,this.bodyHitPt=null},g.RectangularRoiTool.prototype.updatePosition=function(t,e,i){"use strict";if(this.activeElement)this.activeElement.updatePosition(t,e,i);else if(this.bodyHitPt){var s=new g.Point2D;s.x=t.x-this.bodyHitPt.x,s.y=t.y-this.bodyHitPt.y,this.handle1.translate(s,e,i),this.handle2.translate(s,e,i),this.bodyHitPt=t}},g.RectangularRoiTool.prototype.draw=function(t,i,s,n){"use strict";var o=this;this.handle1.draw(i,s,n),this.handle2.draw(i,s,n),this.rectangle.draw(i,this.handle1.imagePt,this.handle2.imagePt,s,n),this.dicomObject=t,this.handle1.isModified()||this.handle2.isModified()?(o.label.draw(i,this.handle2.imagePt,"",s,n),window.clearTimeout(this.timeoutHandle),this.timeoutHandle=window.setTimeout(function(){var t,e="";t=o.rectangle.computeRoi(o.dicomObject,o.handle1.imagePt,o.handle2.imagePt),e="min: "+g.MathHelper.roundTo(t.min,2)+"\nmax: ",e+=g.MathHelper.roundTo(t.max,2),e+="\nmean: "+g.MathHelper.roundTo(t.mean,2),e+="\nstd. dev: "+g.MathHelper.roundTo(t.stdDev,2),e+="\narea: "+g.MathHelper.roundTo(t.area,2),o.label.draw(i,o.handle2.imagePt,e,s,n),o.handle2.resetModified(),o.handle1.resetModified()},100)):this.label.draw(i,this.handle2.imagePt,this.label.text,s,n)},g.RectangularRoiTool.prototype.isHit=function(t,e,i){"use strict";return this.handle1.isHit(t,e,i)?(this.activeElement=this.handle1,!0):this.handle2.isHit(t,e,i)?(this.activeElement=this.handle2,!0):!!this.rectangle.isBodyHit(t,e,i,this.handle1,this.handle2)&&(this.bodyHitPt=t,!0)},g.RectangularRoiTool.prototype.reset=function(){"use strict";this.activeElement=null,this.bodyHitPt=null,this.handle1.resetModified(),this.handle2.resetModified()},(g=g||{}).CircularRoiTool=function(t,e,i){"use strict";var s=g.MathHelper.world2Image(t,e,i);this.handle1=new g.Handle(s.x,s.y/2),this.handle2=new g.Handle(s.x,s.y+s.y/2),this.circle=new g.Circle,this.activeElement=null,this.label=new g.Label,this.dicomObject=null,this.timeoutHandle=null,this.bodyHitPt=null},g.CircularRoiTool.prototype.updatePosition=function(t,e,i){"use strict";if(this.activeElement)this.activeElement.updatePosition(t,e,i);else if(this.bodyHitPt){var s=new g.Point2D;s.x=t.x-this.bodyHitPt.x,s.y=t.y-this.bodyHitPt.y,this.handle1.translate(s,e,i),this.handle2.translate(s,e,i),this.bodyHitPt=t}},g.CircularRoiTool.prototype.draw=function(t,i,s,n){"use strict";var o=this;this.handle1.draw(i,s,n),this.handle2.draw(i,s,n),this.circle.draw(i,this.handle1.imagePt,this.handle2.imagePt,s,n),this.dicomObject=t,this.handle1.isModified()||this.handle2.isModified()?(o.label.draw(i,this.handle2.imagePt,"",s,n),window.clearTimeout(this.timeoutHandle),this.timeoutHandle=window.setTimeout(function(){var t,e="";t=o.circle.computeRoi(o.dicomObject,o.handle1.imagePt,o.handle2.imagePt),e="min: "+g.MathHelper.roundTo(t.min,2)+"\nmax: ",e+=g.MathHelper.roundTo(t.max,2),e+="\nmean: "+g.MathHelper.roundTo(t.mean,2),e+="\nstd. dev: "+g.MathHelper.roundTo(t.stdDev,2),e+="\narea: "+g.MathHelper.roundTo(t.area,2),o.label.draw(i,o.handle2.imagePt,e,s,n),o.handle2.resetModified(),o.handle1.resetModified()},100)):this.label.draw(i,this.handle2.imagePt,this.label.text,s,n)},g.CircularRoiTool.prototype.isHit=function(t,e,i){"use strict";return this.handle1.isHit(t,e,i)?(this.activeElement=this.handle1,!0):this.handle2.isHit(t,e,i)?(this.activeElement=this.handle2,!0):!!this.isBodyHit(t,e,i)&&(this.bodyHitPt=t,!0)},g.CircularRoiTool.prototype.isBodyHit=function(t,e,i){"use strict";var s=g.MathHelper.lineDistance(this.handle1.imagePt,this.handle2.imagePt)/2-g.Constants.handleSize/i,n=g.MathHelper.lineDistance(this.handle1.imagePt,this.handle2.imagePt)/2+g.Constants.handleSize/i,o=new g.Point2D,r=g.MathHelper.world2Image(t,e,i);return o.x=(this.handle2.imagePt.x+this.handle1.imagePt.x)/2,o.y=(this.handle2.imagePt.y+this.handle1.imagePt.y)/2,g.Circle.circleHitTest(o,n,r)&&!g.Circle.circleHitTest(o,s,r)},g.CircularRoiTool.prototype.reset=function(){"use strict";this.activeElement=null,this.bodyHitPt=null,this.handle1.resetModified(),this.handle2.resetModified()},(g=g||{}).TextAnnotateTool=function(t,e,i,s){"use strict";var n=g.MathHelper.world2Image(e,i,s);this.handle1=new g.Handle(n.x,n.y/2),this.handle2=new g.Handle(n.x,n.y+n.y/2),this.line=new g.Line,this.label=new g.Label,this.activeElement=null,this.description=t,this.bodyHitPt=null},g.TextAnnotateTool.prototype.updatePosition=function(t,e,i){"use strict";if(this.activeElement&&this.activeElement.updatePosition(t,e,i),this.bodyHitPt){var s=new g.Point2D;s.x=t.x-this.bodyHitPt.x,s.y=t.y-this.bodyHitPt.y,this.handle1.translate(s,e,i),this.handle2.translate(s,e,i),this.bodyHitPt=t}},g.TextAnnotateTool.prototype.draw=function(t,e,i,s){"use strict";this.handle1.draw(e,i,s),this.handle2.draw(e,i,s),this.line.draw(e,this.handle1.imagePt,this.handle2.imagePt,i,s),this.label.draw(e,this.handle2.imagePt,this.description,i,s)},g.TextAnnotateTool.prototype.isHit=function(t,e,i){"use strict";return this.handle1.isHit(t,e,i)?(this.activeElement=this.handle1,!0):this.handle2.isHit(t,e,i)?(this.activeElement=this.handle2,!0):!!this.line.isHit(t,e,i)&&(this.bodyHitPt=t,!0)},g.TextAnnotateTool.prototype.reset=function(){"use strict";this.activeElement=null,this.bodyHitPt=null,this.handle1.resetModified(),this.handle2.resetModified()},(g=g||{}).ShutterTool=function(t,e,i){"use strict";var s=g.MathHelper.world2Image(t,e,i);this.handle1=new g.Handle(s.x/2,s.y/2),this.handle2=new g.Handle(s.x+s.x/2,s.y+s.y/2),this.rectangle=new g.Rectangle,this.activeElement=null,this.bodyHitPt=null},g.ShutterTool.prototype.updatePosition=function(t,e,i){"use strict";if(this.activeElement)this.activeElement.updatePosition(t,e,i);else if(this.bodyHitPt){var s=new g.Point2D;s.x=t.x-this.bodyHitPt.x,s.y=t.y-this.bodyHitPt.y,this.handle1.translate(s,e,i),this.handle2.translate(s,e,i),this.bodyHitPt=t}},g.ShutterTool.prototype.draw=function(t,e,i,s){"use strict";this.handle1.draw(e,i,s),this.handle2.draw(e,i,s),this.rectangle.draw(e,this.handle1.imagePt,this.handle2.imagePt,i,s)},g.ShutterTool.prototype.isHit=function(t,e,i){"use strict";return this.handle1.isHit(t,e,i)?(this.activeElement=this.handle1,!0):this.handle2.isHit(t,e,i)?(this.activeElement=this.handle2,!0):!!this.rectangle.isBodyHit(t,e,i,this.handle1,this.handle2)&&(this.bodyHitPt=t,!0)},g.ShutterTool.prototype.reset=function(){"use strict";this.activeElement=null,this.bodyHitPt=null,this.handle1.resetModified(),this.handle2.resetModified()},g.ShutterTool.prototype.rect=function(){"use strict";return{p1:this.handle1.imagePt,p2:this.handle2.imagePt}},(g=g||{}).ToolContainer=function(){"use strict";this.tools=[],this.hitSuccess=!1,this.trashImage=new Image,this.trashImage.src="stylesheets/images/trash.png",this.activeToolIndex=-1,this.trashCenter=new g.Point2D(36,36),this.trashRadius=16},g.ToolContainer.prototype.hitTest=function(t,e,i){"use strict";this.activeToolIndex=-1,this.hitSuccess=!1;var s=0,n=new g.Point2D;for(n.x=t.gesture.center.pageX,n.y=t.gesture.center.pageY,s=0;s<this.tools.length;s+=1)if(this.tools[s].isHit(n,e,i)){this.hitSuccess=!0,this.activeToolIndex=s;break}},g.ToolContainer.prototype.isHandlingEvent=function(){"use strict";return this.hitSuccess},g.ToolContainer.prototype.onDragStart=function(t,e,i){},g.ToolContainer.prototype.onDrag=function(t,e,i){"use strict";var s=0,n=new g.Point2D;for(n.x=t.gesture.center.pageX,n.y=t.gesture.center.pageY,s=0;s<this.tools.length;s+=1)this.tools[s].updatePosition(n,e,i)},g.ToolContainer.prototype.onDragEnd=function(t,e,i){"use strict";var s=0,n=new g.Point2D;for(n.x=t.gesture.center.pageX,n.y=t.gesture.center.pageY,s=0;s<this.tools.length;s+=1)this.tools[s].reset();this.hitSuccess=!1,this.isOverTrashIcon(n)&&-1<this.activeToolIndex&&this.tools.splice(this.activeToolIndex,1)},g.ToolContainer.prototype.drawTools=function(t,e,i,s){"use strict";var n=0;for(this.isHandlingEvent()&&this.drawTrashIcon(e),n=0;n<this.tools.length;n+=1)this.tools[n].draw(t,e,i,s)},g.ToolContainer.prototype.isOverTrashIcon=function(t){"use strict";return g.Circle.circleHitTest(this.trashCenter,this.trashRadius,t)},g.ToolContainer.prototype.drawTrashIcon=function(t){"use strict";t.drawImage(this.trashImage,this.trashCenter.x-this.trashRadius,this.trashCenter.y-this.trashRadius,2*this.trashRadius,2*this.trashRadius)},g.ToolContainer.prototype.centerPoint=function(t,e){"use strict";return new g.Point2D(t/2,e/2)},g.ToolContainer.prototype.createDistanceTool=function(t,e,i,s){"use strict";if(""!==this.currentSOP){var n=this.centerPoint(t,e),o=new g.DistanceTool(n,i,s);this.tools.push(o)}else log.warn("cannot create tool, sopInstance not given")},g.ToolContainer.prototype.createAngleTool=function(t,e,i,s){"use strict";if(""!==this.currentSOP){var n=this.centerPoint(t,e),o=new g.AngleTool(n,i,s);this.tools.push(o)}else log.warn("cannot create tool, sopInstance not given")},g.ToolContainer.prototype.createCobbAngleTool=function(t,e,i,s){"use strict";if(""!==this.currentSOP){var n=this.centerPoint(t,e),o=new g.CobbAngleTool(n,i,s);this.tools.push(o)}else log.warn("cannot create tool, sopInstance not given")},g.ToolContainer.prototype.createPointProbeTool=function(t,e,i,s){"use strict";if(""!==this.currentSOP){var n=this.centerPoint(t,e),o=new g.PointProbeTool(n,i,s);this.tools.push(o)}else log.warn("cannot create tool, sopInstance not given")},g.ToolContainer.prototype.createRectRoiTool=function(t,e,i,s){"use strict";if(""!==this.currentSOP){var n=this.centerPoint(t,e),o=new g.RectangularRoiTool(n,i,s);this.tools.push(o)}else log.warn("cannot create tool, sopInstance not given")},g.ToolContainer.prototype.createCircRoiTool=function(t,e,i,s){"use strict";if(""!==this.currentSOP){var n=this.centerPoint(t,e),o=new g.CircularRoiTool(n,i,s);this.tools.push(o)}else log.warn("cannot create tool, sopInstance not given")},g.ToolContainer.prototype.createTextAnnoTool=function(t,e,i,s){"use strict";if(""!==this.currentSOP){var n=window.prompt("Enter description","Annotation"),o=this.centerPoint(t,e),r=new g.TextAnnotateTool(n,o,i,s);n&&this.tools.push(r)}else log.warn("cannot create tool, sopInstance not given")},g.ToolContainer.prototype.createShutterTool=function(t,e,i,s){"use strict";if(""!==this.currentSOP){var n=this.centerPoint(t,e),o=new g.ShutterTool(n,i,s);this.tools.push(o)}else log.warn("cannot create tool, sopInstance not given")},g.ToolContainer.prototype.getShutter=function(){"use strict";var t=0,e=[];for(t=0;t<this.tools.length;t+=1)this.tools[t]instanceof g.ShutterTool&&e.push(this.tools[t]);return e},(g=g||{}).Point2D=function(t,e){"use strict";this.x=0,void(this.y=0)!==t&&void 0!==e&&(this.x=t,this.y=e)},g.DicomViewer=function(t){"use strict";this.viewerCanvasId=t,this.viewerCanvas=window.document.getElementById(t),this.viewerCtx=this.viewerCanvas.getContext("2d"),this.imageCanvas=document.createElement("canvas"),this.imageCtx=this.imageCanvas.getContext("2d"),this.patientData=null,this.interactionMode=0,this.imageQuality="lossy",this.viewerWidth=this.viewerCanvas.width,this.viewerHeight=this.viewerCanvas.height,this.baseURL="",this.currentSOP="",this.imageData=null,this.dicomObject=null,this.dicomLoader=new g.DicomLoader,this.dicomProcessor=new g.DicomProcessor,this.cacheMgr=null,this.toolsHash=new Hashtable,this.imageLoaded=!1,this.preview=!0,this.wc=0,this.ww=0,this.customWL=!1,this.zooming=!1,this.start0=new g.Point2D,this.start1=new g.Point2D,this.startDistanceBetweenFingers=0,this.centerPointStart=new g.Point2D,this.percentageOfImageAtPinchPoint=new g.Point2D,this.currentContinuousZoom=1,this.currentOffset=new g.Point2D,this.currentWidth=512,this.currentHeight=512,this.newContinuousZoom=this.currentContinuousZoom,this.newOffset=new g.Point2D,this.newHeight=512,this.newWidth=512,this.centerImage=!1,this.lastTranslation=null,this.lastDelta=0},g.DicomViewer.prototype.onCanvasResize=function(t,e){"use strict";var i=this;this.viewerWidth=parseInt(t,10),this.viewerHeight=parseInt(e,10),setTimeout(function(){i.viewerCanvas.width=i.viewerWidth,i.viewerCanvas.height=i.viewerHeight,i.redraw()},0)},g.DicomViewer.prototype.reset=function(){"use strict";this.zoomFactor=1},g.DicomViewer.prototype.setInteractionMode=function(t){"use strict";this.interactionMode=parseInt(t,10)},g.DicomViewer.prototype.createTool=function(t){"use strict";var e=this.getToolsContainer(this.currentSOP);switch(t){case 0:e.createDistanceTool(this.viewerCanvas.width,this.viewerCanvas.height,this.newOffset,this.newContinuousZoom);break;case 1:e.createAngleTool(this.viewerCanvas.width,this.viewerCanvas.height,this.newOffset,this.newContinuousZoom);break;case 2:e.createCobbAngleTool(this.viewerCanvas.width,this.viewerCanvas.height,this.newOffset,this.newContinuousZoom);break;case 3:e.createPointProbeTool(this.viewerCanvas.width,this.viewerCanvas.height,this.newOffset,this.newContinuousZoom);break;case 4:e.createRectRoiTool(this.viewerCanvas.width,this.viewerCanvas.height,this.newOffset,this.newContinuousZoom);break;case 5:e.createCircRoiTool(this.viewerCanvas.width,this.viewerCanvas.height,this.newOffset,this.newContinuousZoom);break;case 6:e.createTextAnnoTool(this.viewerCanvas.width,this.viewerCanvas.height,this.newOffset,this.newContinuousZoom);break;case 7:e.createShutterTool(this.viewerCanvas.width,this.viewerCanvas.height,this.newOffset,this.newContinuousZoom);break;default:return void log.warn("default not implemented")}this.setInteractionMode(4),this.redraw()},g.DicomViewer.prototype.preparePinch=function(){"use strict";var t=this.currentWidth,e=this.currentHeight;this.currentContinuousZoom=this.newContinuousZoom,this.currentOffset.x=this.newOffset.x,this.currentOffset.y=this.newOffset.y,this.currentWidth=this.newWidth,this.currentHeight=this.newHeight,this.centerPointStart.x=(this.start0.x+this.start1.x)/2,this.centerPointStart.y=(this.start0.y+this.start1.y)/2,this.percentageOfImageAtPinchPoint.x=(this.centerPointStart.x-this.currentOffset.x)/t,this.percentageOfImageAtPinchPoint.y=(this.centerPointStart.y-this.currentOffset.y)/e,this.startDistanceBetweenFingers=Math.sqrt(Math.pow(this.start1.x-this.start0.x,2)+Math.pow(this.start1.y-this.start0.y,2)),this.zooming=!0},g.DicomViewer.prototype.isHandlingEvents=function(){"use strict";return this.getToolsContainer(this.currentSOP).isHandlingEvent()},g.DicomViewer.prototype.onDragStart=function(t){"use strict";var e=this.getToolsContainer(this.currentSOP);if(e.hitTest(t,this.newOffset,this.newContinuousZoom),e.isHandlingEvent())return e.onDragStart(t,this.newOffset,this.newContinuousZoom),void this.redraw();if(1===t.gesture.touches.length)this.start0.x=t.gesture.touches[0].pageX,this.start0.y=t.gesture.touches[0].pageY;else{if(2!==t.gesture.touches.length)return void log.warn("invalid touch event");this.start0.x=t.gesture.touches[0].pageX,this.start0.y=t.gesture.touches[0].pageY,this.start1.x=t.gesture.touches[1].pageX,this.start1.y=t.gesture.touches[1].pageY,this.preparePinch()}},g.DicomViewer.prototype.onDrag=function(t){"use strict";var e=0,i=new g.Point2D,s=new g.Point2D,n=0,o=1,r=new g.Point2D,a=new g.Point2D,h=new g.Point2D,l=new g.Point2D,c=this.getToolsContainer(this.currentSOP);if(c.isHandlingEvent())return c.onDrag(t,this.newOffset,this.newContinuousZoom),void this.redraw();if(1===t.gesture.touches.length)i.x=t.gesture.touches[0].pageX,i.y=t.gesture.touches[0].pageY,s.x=this.start1.x,s.y=this.start1.y;else{if(2!==t.gesture.touches.length)return void log.warn("invalid touch event");if(!this.zooming)return this.start1.x=t.gesture.touches[1].pageX,this.start1.y=t.gesture.touches[1].pageY,void this.preparePinch();i.x=t.gesture.touches[0].pageX,i.y=t.gesture.touches[0].pageY,s.x=t.gesture.touches[1].pageX,s.y=t.gesture.touches[1].pageY}if(h.x=i.x-this.start0.x,h.y=i.y-this.start0.y,this.lastTranslation){if(this.lastTranslation.x===h.x&&this.lastTranslation.y===h.y)return;this.lastTranslation=h}if(1===t.gesture.touches.length)switch(this.interactionMode){case 0:return;case 1:return this.newOffset.x=this.currentOffset.x+h.x,this.newOffset.y=this.currentOffset.y+h.y,void this.drawImage();case 2:return e=h.y,this.zoomto(e-this.lastDelta,this.start0.x,this.start0.y),void(this.lastDelta=e);case 3:return this.start0.x=i.x,this.start0.y=i.y,this.wc=parseInt(this.wc+h.x,10),this.ww=parseInt(this.ww+h.y,10),this.customWL=!0,void(this.dicomObject&&(this.imageData=this.dicomProcessor.getRenderData(this.dicomObject,this.wc,this.ww),this.drawImage()));case 4:return;default:return void log.warn("default not implemented")}else if(this.zooming){if(0===this.startDistanceBetweenFingers)return void log.warn("invalid distance of zero");if(n=Math.sqrt(Math.pow(s.x-i.x,2)+Math.pow(s.y-i.y,2)),0===this.endDistanceBetweenFingers)return void log.warn("invalid distance of zero");if(10<(o=n/this.startDistanceBetweenFingers)||o<.1)return void log.warn("invalid ratio");this.newContinuousZoom=o*this.currentContinuousZoom,this.newWidth=this.imageCanvas.width*this.newContinuousZoom,this.newHeight=this.imageCanvas.height*this.newContinuousZoom,r.x=(i.x+s.x)/2,r.y=(i.y+s.y)/2,a.x=(this.currentWidth-this.newWidth)*this.percentageOfImageAtPinchPoint.x,a.y=(this.currentHeight-this.newHeight)*this.percentageOfImageAtPinchPoint.y,h.x=r.x-this.centerPointStart.x,h.y=r.y-this.centerPointStart.y,l.x=a.x+h.x,l.y=a.y+h.y,this.newOffset.x=this.currentOffset.x+l.x,this.newOffset.y=this.currentOffset.y+l.y,this.drawImage()}},g.DicomViewer.prototype.onDragEnd=function(t){"use strict";var e=this.getToolsContainer(this.currentSOP);if(e.isHandlingEvent())return e.onDragEnd(t,this.newOffset,this.newContinuousZoom),void this.redraw();this.currentOffset.x=this.newOffset.x,this.currentOffset.y=this.newOffset.y,this.currentWidth=this.newWidth,this.currentHeight=this.newHeight,this.currentContinuousZoom=this.newContinuousZoom,this.zooming=!1,this.lastTranslation=null,this.lastDelta=0},g.DicomViewer.prototype.zoomto=function(t,e,i){"use strict";var s=t*this.newContinuousZoom/100,n=new g.Point2D(e,i);this.newOffset=g.MathHelper.world2Offset(n,this.newOffset,this.newContinuousZoom,this.newContinuousZoom+s),this.newContinuousZoom=this.newContinuousZoom+s,this.currentOffset.x=this.newOffset.x,this.currentOffset.y=this.newOffset.y,this.currentWidth=this.newWidth,this.currentHeight=this.newHeight,this.currentContinuousZoom=this.newContinuousZoom,this.zooming=!1,this.drawImage(),this.currentContinuousZoom=this.newContinuousZoom},g.DicomViewer.prototype.onMouseWheelMove=function(t,e){"use strict";this.zoomto(10*e,t.pageX,t.pageY)},g.DicomViewer.prototype.init=function(t,e,i){"use strict";this.baseURL=t,this.patientData=e,this.cacheMgr=i,this.imageLoaded=!1,this.preview=!0,this.customWL=!1,this.dicomObject=null},g.DicomViewer.prototype.loadDicom=function(e){"use strict";this.currentSOP=e;var a=this;function h(t){if(t){var e=(a.dicomObject=t).getHeader(),i=e.rows(),s=e.cols(),n=e.windowCenter(),o=e.windowWidth(),r=a.dicomProcessor;a.customWL||(a.wc=n,a.ww=o),a.viewerCtx.fillRect(0,0,s,i),a.imageData=r.getRenderData(t,a.wc,a.ww),a.imageCanvas.width=s,a.imageCanvas.height=i,a.centerImage=!0,100!==t.getQuality()?(a.imageQuality="lossy",log.debug("loading full version"),a.dicomLoader.load(a.baseURL+a.currentSOP,200,100).then(h)):(a.imageQuality="lossless",window.pubsub.pub("sliceLoadStop",a.currentSOP)),a.drawImage()}else log.warn("invalid dicomObject")}this.cacheMgr.get(e).then(function(t){log.debug("cache hit",e),h(t)},function(){window.pubsub.pub("sliceLoadStart",e),a.dicomLoader.load(a.baseURL+a.currentSOP,30,50).then(h)})},g.DicomViewer.prototype.drawImage=function(){"use strict";this.imageCtx.putImageData(this.imageData,0,0),this.imageLoaded=!0,this.redraw()},g.DicomViewer.prototype.redraw=function(){"use strict";if(""!==this.currentSOP){var t,e,i,s,n,o,r,a,h,l=this.getToolsContainer(this.currentSOP),c=1,u=0,d=0;if(this.viewerCtx)if(this.viewerCtx.fillStyle="rgb(0,0,0)",this.viewerCtx.fillRect(0,0,this.viewerCanvas.width,this.viewerCanvas.height),this.centerImage&&1===this.currentContinuousZoom&&(c=this.viewerHeight>this.viewerWidth?this.viewerWidth/this.imageCanvas.width:this.viewerHeight/this.imageCanvas.height,this.newContinuousZoom=this.newContinuousZoom*c,this.currentContinuousZoom=this.newContinuousZoom,this.newWidth=this.imageCanvas.width*this.newContinuousZoom,this.newHeight=this.imageCanvas.height*this.newContinuousZoom),t=this.imageCanvas.width*this.newContinuousZoom,e=this.imageCanvas.height*this.newContinuousZoom,this.centerImage&&0===this.newOffset.x&&0===this.newOffset.y&&(this.centerImage=!1,u=(this.viewerWidth-t)/2,d=(this.viewerHeight-e)/2,this.newOffset.x+=u,this.newOffset.y+=d,this.currentOffset.x=this.newOffset.x,this.currentOffset.y=this.newOffset.y),t=Math.ceil(t),e=Math.ceil(e),t<1)log.warn("width ",t);else if(e<1)log.warn("height ",e);else{if(0<(i=this.getToolsContainer(this.currentSOP).getShutter()).length){for(this.viewerCtx.save(),this.viewerCtx.beginPath(),h=0;h<i.length;h+=1)s=i[h].rect(),n=g.MathHelper.image2World(s.p1,this.newOffset,this.newContinuousZoom),r=(o=g.MathHelper.image2World(s.p2,this.newOffset,this.newContinuousZoom)).x-n.x,a=o.y-n.y,this.viewerCtx.rect(n.x,n.y,r,a),this.viewerCtx.closePath();this.viewerCtx.clip()}this.viewerCtx.drawImage(this.imageCanvas,this.newOffset.x,this.newOffset.y,t,e),0<i.length&&this.viewerCtx.restore(),this.getToolsContainer(this.currentSOP).drawTools(this.dicomObject,this.viewerCtx,this.newOffset,this.newContinuousZoom),l.isHandlingEvent()||this.drawOverlay()}else log.error("context not available")}},g.DicomViewer.prototype.drawOverlay=function(){"use strict";if("undefined"!==this.patientData&&null!==this.patientData){var t,e,i,s,n,o,r,a,h,l,c,u,d=this.viewerCanvas.height,p=this.viewerCanvas.width-20,g=(this.viewerCanvas.width,parseFloat(this.viewerCanvas.height/25)),w=parseInt(g/1.5,10),f="";this.viewerCtx.font=w+"pt Helvetica bold, sans-serif",this.viewerCtx.fillStyle="White",this.viewerCtx.strokeStyle="black",this.viewerCtx.textAlign="left",t="Name: "+this.patientData.DCM_PatientName,this.viewerCtx.fillText(t,20,g),e="ID: "+this.patientData.DCM_PatientID,this.viewerCtx.fillText(e,20,2*g),i="Acc: "+this.patientData.DCM_AccessionNumber,this.viewerCtx.fillText(i,20,3*g),this.dicomObject&&(f="ImageNr: "+this.dicomObject.getHeader().dicomData.DCM_InstanceNumber,this.viewerCtx.fillText(f,20,4*g)),this.viewerCtx.textAlign="right",s=this.patientData.DCM_StudyDescription,this.viewerCtx.fillText(s,p,g),n=this.patientData.DCM_SeriesDescription,this.viewerCtx.fillText(n,p,2*g),o="Ref: "+this.patientData.DCM_ReferringPhysicianName,this.viewerCtx.fillText(o,p,3*g),this.viewerCtx.textAlign="left","lossless"===this.imageQuality?this.viewerCtx.fillStyle="Green":this.viewerCtx.fillStyle="Red",l="Quality: "+this.imageQuality,this.viewerCtx.fillText(l,20,d-3*g),this.viewerCtx.fillStyle="White",a="SeriesDate: "+this.patientData.DCM_SeriesDate,this.viewerCtx.fillText(a,20,d-2*g),h="SeriesTime: "+this.patientData.DCM_SeriesTime,this.viewerCtx.fillText(h,20,d-g),this.viewerCtx.textAlign="right",r="W"+this.ww+" |  C"+this.wc,this.viewerCtx.fillText(r,p,d-3*g),c="BodyPart: "+this.patientData.DCM_BodyPartExamined,this.viewerCtx.fillText(c,p,d-2*g),u="Position: "+this.patientData.DCM_PatientPosition,this.viewerCtx.fillText(u,p,d-g)}},g.DicomViewer.prototype.getToolsContainer=function(t){"use strict";if(void 0!==t&&""!==t)return this.toolsHash.containsKey(t)||this.toolsHash.put(t,new g.ToolContainer),this.toolsHash.get(t);log.warn("sopInstanceUID not given")},(g=g||{}).Slider=function(t){"use strict";this.canvas=window.document.getElementById(t),this.context=this.canvas.getContext("2d"),this.sliderTimeout=null,this.currentPercentage=0,this.currentRemainingTime=0,this.currentMin=0,this.currentMax=0,this.currentSliderPosition=0,this.sliderVisible=!1},g.Slider.prototype.draw=function(){"use strict";this.clear(),this.drawSlider(),this.drawLabel()},g.Slider.prototype.setSliderPosition=function(t,e,i){"use strict";var s=this;this.currentMin=t,this.currentMax=e,this.currentSliderPosition=i,this.sliderVisible=!0,this.draw(),window.clearTimeout(this.sliderTimeout),this.sliderTimeout=window.setTimeout(function(){s.clear(),s.sliderVisible=!1},1e3)},g.Slider.prototype.setLabel=function(t,e){"use strict";this.currentPercentage=t,this.currentRemainingTime=e,this.draw()},g.Slider.prototype.drawSlider=function(){"use strict";if(!0===this.sliderVisible){var t=g.MathHelper.clamp(this.currentSliderPosition,this.currentMin,this.currentMax),e=parseInt(this.canvas.height/5,10),i=parseInt(this.canvas.height-2*e,10),s=parseInt(this.canvas.width,10),n=parseInt(this.currentMax,10),o=parseInt(s/20,10),r=parseInt(i*g.MathHelper.clamp(t/n,0,this.currentMax),10)+e;isNaN(e)||isNaN(o)||isNaN(r)?log.warn("slider invalid",e,o,r):(this.drawBar(o,e,20,i+50),this.drawKnob(o,r,20,50))}},g.Slider.prototype.drawBar=function(t,e,i,s){"use strict";this.context.strokeStyle="LightGray",this.context.fillStyle="gray",this.roundRect(this.context,t,e,i,s,10,!0,!0)},g.Slider.prototype.drawKnob=function(t,e,i,s){"use strict";this.context.strokeStyle="gray",this.context.fillStyle="LightGray",this.roundRect(this.context,t,e,i,s,10,!0,!0)},g.Slider.prototype.roundRect=function(t,e,i,s,n,o,r,a){"use strict";void 0===a&&(a=!0),void 0===o&&(o=5),t.beginPath(),t.moveTo(e+o,i),t.lineTo(e+s-o,i),t.quadraticCurveTo(e+s,i,e+s,i+o),t.lineTo(e+s,i+n-o),t.quadraticCurveTo(e+s,i+n,e+s-o,i+n),t.lineTo(e+o,i+n),t.quadraticCurveTo(e,i+n,e,i+n-o),t.lineTo(e,i+o),t.quadraticCurveTo(e,i,e+o,i),t.closePath(),a&&t.stroke(),r&&t.fill()},g.Slider.prototype.clear=function(){"use strict";this.context.clearRect(0,0,this.canvas.width,this.canvas.height)},g.Slider.prototype.drawLabel=function(){"use strict";var t,e,i,s,n,o,r,a,h,l=parseFloat(this.canvas.height/25),c=parseInt(l/1.5,10),u="DL: "+this.currentPercentage+"% "+(t=this.currentRemainingTime,e=parseInt(t,10),i=parseInt(e/3600,10)%24,s=parseInt(e/60,10)%60,o=(i<10?"0"+i:i)+":",r=(s<10?"0"+s:s)+":",a=((n=e%60)<10?"0"+n:n)+"s",h="",isNaN(e)?h:h=0<s?"~"+o+r+a:"~"+n+"s"),d=parseInt(this.currentPercentage,10)<100;this.context.font=c+"pt Helvetica bold, sans-serif",this.context.fillStyle="White",this.context.strokeStyle="black",d&&this.drawText(u)},g.Slider.prototype.drawText=function(t){"use strict";var e=parseInt(this.canvas.height/25,10),i=this.canvas.width-20;this.context.textAlign="right",this.context.fillText(t,i,4*e)},(g=g||{}).ViewMaster=function(t,e){"use strict";this.viewer_id=t,this.viewerCanvas=window.document.getElementById(t),this.overlayCanvas=window.document.getElementById(e),this.singleViewer=new g.DicomViewer(t),this.viewer=this.singleViewer,this.cache=new g.CacheManager,this.slider=new g.Slider(e),this.cache.init(),this.interactionMode=0,this.currentSliderPos=0,this.sopInstances={},this.sliderPosTemp=0,this.lastSOP="",this.lastPosY=0,this.preloaderTimeout=0;var i=this;this.preloader=new g.Preloader(this.cache,function(t,e){i.drawPreloadingLabel(t,e)}),this.prepare(),window.pubsub.sub("sliceLoadStart",function(t){i.preloader.isRunning()&&i.preloader.stop()}),window.pubsub.sub("sliceLoadStop",function(t){log.debug("slice loading finished",t),i.preloader.isRunning()||(log.debug("slice loading finished, restarting preloader"),0!==i.preloaderTimeout&&(window.clearTimeout(i.preloaderTimeout),i.preloaderTimeout=0),i.preloaderTimeout=setTimeout(function(){i.preloader.start(t)},500))})},g.ViewMaster.prototype.reset=function(){"use strict";this.interactionMode=0,this.currentSliderPos=0,this.sopInstances={},this.sliderPosTemp=0,this.lastPosY=0,this.sliderTimeout=0,this.preloaderTimeout=0},g.ViewMaster.prototype.prepare=function(){"use strict";var a=this,t=new Hammer(this.overlayCanvas,{drag_min_distance:1,drag_horizontal:!0,drag_vertical:!0,transform:!0,hold:!1,prevent_default:!0,drag_max_touches:2});t.on("dragstart",function(t){a.sliderPosTemp=a.currentSliderPos,a.lastPosY=t.gesture.center.pageY,a.viewer.onDragStart(t)}),t.on("drag",function(t){if(1===t.gesture.touches.length&&!1===a.viewer.isHandlingEvents()&&0===a.viewer.interactionMode){var e,i=a.sopInstances.length,s=0,n=0,o="",r=t.gesture.center.pageY;if(e=-1*(a.lastPosY-r),0===a.interactionMode)return i<10&&(i=10),0!==(s=parseInt(i/a.viewerCanvas.height*e,10))&&(n=parseInt(a.sliderPosTemp+s,10),n=g.MathHelper.clamp(n,0,a.sopInstances.length-1),o=a.getCurrentSOP(n)),void(a.lastSOP!==o&&""!==o&&(a.viewer.loadDicom(o),a.drawSlider(n),a.lastSOP=o))}a.viewer.onDrag(t)}),t.on("dragend",function(t){a.viewer.onDragEnd(t)}),$(this.overlayCanvas).bind("mousewheel.TileViewerer",function(t,e){a.viewer.onMouseWheelMove(t,e)})},g.ViewMaster.prototype.onResize=function(t,e){"use strict";this.viewer.onCanvasResize(t,e),this.overlayCanvas.width=t,this.overlayCanvas.height=e,this.slider.draw()},g.ViewMaster.prototype.init=function(e,t,i){"use strict";var s=this,n=null,o="";null!==t&&""!==t&&null!==i&&""!==i?(this.reset(),$.ajax({url:"/queryStudyAndSeriesInfo",dataType:"json",data:{stdUID:t,serUID:i}}).then(function(t){$.each(t,function(t,e){n=e}),s.sopInstances=n.LocalInstances.split("#"),s.currentSliderPos=parseInt(s.sopInstances.length/2,10),s.getViewer(n.DCM_Modality),s.viewer.init(e,n,s.cache),s.preloader.init(e,s.sopInstances),o=s.getCurrentSOP(s.currentSliderPos),s.viewer.setInteractionMode(s.interactionMode),s.viewer.loadDicom(o),1<s.sopInstances.length&&s.drawSlider(s.currentSliderPos),s.viewer.onCanvasResize(s.viewerCanvas.width,s.viewerCanvas.height)})):log.warning("init failed, invalid input"+t+i)},g.ViewMaster.prototype.drawSlider=function(t){"use strict";this.slider.setSliderPosition(0,this.sopInstances.length-1,t)},g.ViewMaster.prototype.drawPreloadingLabel=function(t,e){"use strict";this.slider.setLabel(t,e)},g.ViewMaster.prototype.setInteractionMode=function(t){"use strict";this.interactionMode=t,this.viewer.setInteractionMode(t)},g.ViewMaster.prototype.createTool=function(t){"use strict";this.viewer.createTool(t)},g.ViewMaster.prototype.getCurrentSOP=function(t){"use strict";var e=g.MathHelper.clamp(parseInt(t,10),0,this.sopInstances.length-1);return this.currentSliderPos=e,this.sopInstances[e]},g.ViewMaster.prototype.getViewer=function(t){"use strict";return this.viewer=null,this.viewer=new g.DicomViewer(this.viewer_id),this.interactionMode=0,this.viewer},g.ViewMaster.prototype.stringContains=function(t,e){"use strict";return-1!==t.search(e)};var o={studyUID:null,seriesUID:null,studyIdent:new Hashtable},e=null,r="none",s=(new Date).getTime(),n=!1,a=!1;function h(t){"use strict";return"<h3>"+t.DCM_PatientName+" ("+t.DCM_PatientSex+") - "+t.DCM_PatientID+" - "+t.DCM_PatientsBirthDate+"</h3><p><b>Study date: </b>"+t.DCM_StudyDate+"  <b>Description: </b>"+t.DCM_StudyDescription+"  <b>Modalities: </b>"+t.DCM_ModalitiesInStudy+"</p><p><b>Study time: </b>"+t.DCM_StudyTime+"  <b>Acc.No: </b>"+t.DCM_AccessionNumber+"  <b>Ref.Physician: </b>"+t.DCM_ReferringPhysicianName+"</p><span class='ui-li-count'>"+t.DCM_NumberOfStudyRelatedSeries+"</span>"}function l(t,e){"use strict";return"<a href='#'><img src=/queryThumbnail?stdUID="+o.studyUID+"&serUID="+e+" class='ui-li-thumb' ><h2>Description: "+t.DCM_SeriesDescription+"</h2><p><b>Series Date: </b>"+t.DCM_SeriesDate+"  <b>Modality: </b>"+t.DCM_Modality+"  <b>Protocol: </b>"+t.DCM_ProtocolName+"</p><span class='ui-li-count'>"+t.DCM_NumberOfSeriesRelatedInstances+"</span>"}log.setLevel("warn"),$(document).on("pagebeforechange",function(t,e){"use strict";var i=(new Date).getTime()-s;if(a&&(i<200||n))return t.preventDefault(),n=!1,s=(new Date).getTime(),!1}),$(document).on("pageinit","#studies",function(){"use strict";$(".iscroll-wrapper",this).bind({iscroll_onscrollmove:function(){n=!0},iscroll_onscrollend:function(){n=!1,s=(new Date).getTime()}});$("#pn-study-listview").on("filterablebeforefilter",function(e,t){var i=$("#pn-study-listview-dynamic"),s=$(t.input).val(),n="";a=!0,o.studyIdent.clear(),s&&0<s.length&&$.ajax({url:"/queryStudyInfo",dataType:"json",data:{patName:s+"*"}}).then(function(t){$.each(t,function(t,e){var i=e,s=h(i);n+="<li id='"+t+"' data-theme='b'><a href='#'>"+s+"</li>",o.studyIdent.put(t,i)}),!0!==e.handled&&$("#pn-study-listview-dynamic").on("click","li",function(){o.studyUID=this.id,$.mobile.pageContainer.pagecontainer("change","#series",{transition:r,reload:!0})}),i.html(n),i.listview("refresh"),i.trigger("updatelayout")})});var t=$("#pn-study-listview").prev().children(".ui-input-search").children("input");t.val("*"),t.trigger("change")}),$(document).on("pageinit","#series",function(){"use strict";null===o.studyUID&&(log.warn("redirecting to study"),$.mobile.pageContainer.pagecontainer("change","#studies",{transition:"none",reload:!0}))}),$(document).on("pagebeforeshow","#series",function(){"use strict";if(null!==o.studyUID){var e=$("#pn-series-listview"),t=o.studyUID,s="",i=o.studyIdent.get(t);e.html(""),$("#label").text(i.DCM_PatientName+" - "+i.DCM_PatientID+" - "+i.DCM_StudyDescription),e.html("<li><div class='ui-loader'><span class='ui-icon ui-icon-loading'></span></div></li>"),e.listview("refresh"),$.ajax({url:"/querySeriesInfo",dataType:"json",data:{stdUID:t}}).then(function(t){$.each(t,function(t,e){var i=l(e,t);s+="<li id='"+t+"' data-theme='b'>"+i+"</li>"}),$("#pn-series-listview").off("click","li"),$("#pn-series-listview").on("click","li",function(){o.seriesUID=this.id,$.mobile.pageContainer.pagecontainer("change","#images",{transition:r,reload:!0})}),e.html(s),e.listview("refresh"),e.trigger("updatelayout")})}}),$(document).on("pageinit","#images",function(){"use strict";null!==o.studyUID&&null!==o.seriesUID||(log.warn("redirecting to study"),$.mobile.pageContainer.pagecontainer("change","#studies",{transition:r,reload:!0})),e||(e=new g.ViewMaster("viewerCanvas","overlayCanvas")),$("#tool-listview").on("click","li",function(){switch(this.id){case"li-stack":e.setInteractionMode(0);break;case"li-pan":e.setInteractionMode(1);break;case"li-zoom":e.setInteractionMode(2);break;case"li-window":e.setInteractionMode(3);break;case"li-select":e.setInteractionMode(4);break;default:log.warn("default not implemented")}$("#tool-panel-left").panel("close")}),$("#tool-listview-2").on("click","li",function(){switch(this.id){case"li-distance":e.createTool(0);break;case"li-angle":e.createTool(1);break;case"li-cobb-angle":e.createTool(2);break;case"li-point":e.createTool(3);break;case"li-roi-1":e.createTool(4);break;case"li-roi-2":e.createTool(5);break;case"li-anno":e.createTool(6);break;case"li-shutter":e.createTool(7);break;default:log.warn("default not implemented")}$("#tool-panel-right").panel("close")}),$(window).on("resize",function(){e.onResize($(window).width(),$(window).height()),$("#overlayCanvas").width($(window).width()).height($(window).height())})}),$(document).on("pagebeforeshow","#images",function(){"use strict";if(null!==o.studyUID&&null!==o.seriesUID){var t="/?stdUID="+o.studyUID+"&serUID="+o.seriesUID+"&imgUID=";e.init(t,o.studyUID,o.seriesUID),e.onResize($(window).width(),$(window).height()),$("#overlayCanvas").width($(window).width()).height($(window).height())}});